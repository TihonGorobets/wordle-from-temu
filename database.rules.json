{
  "rules": {
    "parties": {
      "$partyCode": {
        ".read": "auth != null && (!data.exists() || data.child('status').val() === 'lobby' || data.child('players').child(auth.uid).exists())",
        ".write": "auth != null && (!data.exists() || data.child('host').val() === auth.uid)",

        "host": {
          ".validate": "newData.isString() && (!data.exists() ? newData.val() === auth.uid : newData.val() === data.val())"
        },

        "status": {
          ".write": "auth != null && root.child('parties/' + $partyCode + '/host').val() === auth.uid",
          ".validate": "newData.val() === 'lobby' || newData.val() === 'choosing' || newData.val() === 'playing' || newData.val() === 'results'"
        },
        "gameMode": {
          ".write": "auth != null && root.child('parties/' + $partyCode + '/host').val() === auth.uid",
          ".validate": "newData.val() === 'classic' || newData.val() === 'custom'"
        },
        "targetWord": {
          ".write": "auth != null && root.child('parties/' + $partyCode + '/host').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val().length === 0 || (newData.val().length === 5 && newData.val().matches(/^[A-Za-z]{5}$/)))"
        },
        "round": {
          ".write": "auth != null && root.child('parties/' + $partyCode + '/host').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "wordSetterIndex": {
          ".write": "auth != null && root.child('parties/' + $partyCode + '/host').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "wordQueue": {
          ".write": "auth != null && root.child('parties/' + $partyCode + '/host').val() === auth.uid",
          "$index": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 128"
          }
        },

        "players": {
          "$playerId": {
            ".write": "auth != null && (auth.uid === $playerId || root.child('parties/' + $partyCode + '/host').val() === auth.uid)",
            "name": {
              ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 20"
            },
            "done":       { ".validate": "newData.isBoolean()" },
            "won":        { ".validate": "newData.isBoolean()" },
            "guessCount": { ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 6" },
            "isWordSetter":{ ".validate": "newData.isBoolean()" },
            "typing": {
              ".validate": "newData.isString() && newData.val().length <= 5"
            },
            "proposedWord": {
              ".validate": "!newData.exists() || (newData.isString() && newData.val().matches(/^[A-Za-z]{1,5}$/))"
            },
            "guesses": {
              "$rowIndex": {
                "word":   { ".validate": "newData.isString() && newData.val().length === 5" },
                "result": {
                  ".validate": "newData.isString() && newData.val().matches(/^(correct|present|absent)(,(correct|present|absent)){4}$/)"
                },
                "$other": { ".validate": false }
              }
            },
            "$other": { ".validate": false }
          }
        },
        "$other": { ".validate": false }
      }
    },

    "$other": {
      ".read":  false,
      ".write": false
    }
  }
}
